name: ADANiD Ecosystem Auto-Deploy

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0' # Weekly updates

env:
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
  KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  # =============================================================================
  # 1. BUILD & TEST
  # =============================================================================
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install huggingface-hub kaggle supabase mergekit torch transformers librosa soundfile datasets

      - name: Run tests
        run: |
          python -m pytest tests/ --verbose

  # =============================================================================
  # 2. MIGRATE TO UNIVERSAL STANDARD
  # =============================================================================
  migrate-universal:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Migrate models to universal standard        run: |
          python scripts/migrate_models.py

  # =============================================================================
  # 3. TRAIN UNIVERSAL MODEL
  # =============================================================================
  train-universal:
    needs: migrate-universal
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Train universal Islamic AI model
        run: |
          python scripts/train_universal.py

  # =============================================================================
  # 4. MERGE MULTIMODAL MODEL
  # =============================================================================
  merge-multimodal:
    needs: train-universal
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install MergeKit and dependencies
        run: |
          pip install mergekit torch transformers

      - name: Merge Multimodal QuranLab
        run: |
          mergekit-yaml models/mergekit-multimodal-islamic.yaml ./merged-multimodal --cuda

      - name: Upload merged model to Hugging Face
        run: |
          huggingface-cli login --token ${{ secrets.HF_TOKEN }}
          huggingface-cli upload ADANiD/multimodal-islamic-ai \
            ./merged-multimodal \
            ./ \
            --repo-type model

  # =============================================================================
  # 5. MERGE QURANLAB-AI MODEL
  # =============================================================================
  merge-quranlab-ai:
    needs: merge-multimodal
    runs-on: ubuntu-latest
    steps:      - name: Checkout code
        uses: actions/checkout@v4

      - name: Merge Quranlab-AI models
        run: |
          mergekit-yaml models/mergekit-quranlab-ai.yaml ./merged-quranlab-ai --cuda

      - name: Upload merged model to Hugging Face
        run: |
          huggingface-cli upload ADANiD/Quranlab-AI \
            ./merged-quranlab-ai \
            ./ \
            --repo-type model

  # =============================================================================
  # 6. MERGE NOOREABJAD ENHANCED MODEL
  # =============================================================================
  merge-nooreabjad:
    needs: merge-quranlab-ai
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Merge Noor-e-Abjad Enhanced Model
        run: |
          mergekit-yaml models/mergekit-nooreabjad-enhanced.yaml ./merged-nooreabjad --cuda

      - name: Upload merged model to Hugging Face
        run: |
          huggingface-cli upload ADANiD/nooreabjad-enhanced \
            ./merged-nooreabjad \
            ./ \
            --repo-type model

  # =============================================================================
  # 7. UPLOAD UNIVERSAL FOUNDATION MODEL
  # =============================================================================
  upload-universal-model:
    needs: merge-nooreabjad
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Upload Universal Islamic AI Foundation Model
        run: |
          huggingface-cli login --token ${{ secrets.HF_TOKEN }}
          huggingface-cli upload ADANiD/islamic-ai-foundation \
            models/islamic-ai-foundation \            ./ \
            --repo-type model

  # =============================================================================
  # 8. UPDATE HUGGING FACE DATASET
  # =============================================================================
  update-hf-dataset:
    needs: upload-universal-model
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Upload dataset
        run: |
          huggingface-cli login --token ${{ secrets.HF_TOKEN }}
          huggingface-cli upload ADANiD/Quranlab-islamic-dataset \
            datasets/quranlab-islamic-dataset \
            ./ \
            --repo-type dataset

  # =============================================================================
  # 9. UPDATE HUGGING FACE MODELS (QuranLab Core)
  # =============================================================================
  update-hf-models:
    needs: update-hf-dataset
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Upload Quranlab model
        run: |
          huggingface-cli upload ADANiD/Quranlab \
            models/quranlab/README.md \
            ./ \
            --repo-type model

  # =============================================================================
  # 10. UPLOAD DEMO FILES TO HUGGING FACE
  # =============================================================================
  upload-demo-files:
    needs: update-hf-models
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Upload universal demo notebook
        run: |          huggingface-cli upload ADANiD/islamic-ai-foundation \
            notebooks/universal-islamic-ai-demo.ipynb \
            ./ \
            --repo-type model

      - name: Upload multimodal demo notebook
        run: |
          huggingface-cli upload ADANiD/multimodal-islamic-ai \
            notebooks/multimodal-islamic-ai-demo.ipynb \
            ./ \
            --repo-type model

      - name: Upload Noor-e-Abjad demo notebook
        run: |
          huggingface-cli upload ADANiD/nooreabjad-enhanced \
            notebooks/nooreabjad-demo.ipynb \
            ./ \
            --repo-type model

      - name: Upload Quranlab-AI demo notebook
        run: |
          huggingface-cli upload ADANiD/Quranlab-AI \
            notebooks/quranlab-ai-demo.ipynb \
            ./ \
            --repo-type model

      - name: Upload demo files for Space
        run: |
          huggingface-cli upload ADANiD/quranlab-demo \
            demos/app.py \
            ./ \
            --repo-type space
          huggingface-cli upload ADANiD/quranlab-demo \
            demos/requirements.txt \
            ./ \
            --repo-type space

  # =============================================================================
  # 11. UPDATE KAGGLE RESOURCES
  # =============================================================================
  update-kaggle:
    needs: upload-demo-files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Kaggle CLI
        run: |
          pip install kaggle          mkdir -p ~/.kaggle
          echo '{"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_KEY }}"}' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      - name: Update Kaggle dataset
        run: |
          kaggle datasets version \
            -p nooreabjad-dataset \
            -m "feat: universal islamic ai integration with enhanced abjad validation $(date)"

      - name: Update Kaggle notebook
        run: |
          kaggle kernels push -p kaggle/nooreabjad-dataset/notebooks/

  # =============================================================================
  # 12. UPDATE SUPABASE SCHEMA
  # =============================================================================
  update-supabase:
    needs: update-kaggle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        run: |
          npm install -g supabase

      - name: Deploy database schema
        run: |
          supabase db push \
            --project-ref wcrchcdqaikhrhqzxfcy \
            --api-key ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

  # =============================================================================
  # 13. DEPLOY HUGGING FACE SPACE
  # =============================================================================
  deploy-hf-space:
    needs: update-supabase
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Hugging Face Space
        run: |
          huggingface-cli upload ADANiD/quranlab-demo \
            spaces/quranlab-demo \
            ./ \
            --repo-type space
  # =============================================================================
  # 14. NOTIFICATION
  # =============================================================================
  notify:
    needs: deploy-hf-space
    runs-on: ubuntu-latest
    steps:
      - name: Send success notification
        run: |
          echo "✅ ADANiD Ecosystem auto-deployed successfully!"
          echo "✅ Universal Islamic AI Foundation Model deployed"
          echo "✅ All models migrated to universal standard"
          echo "✅ Noor-e-Abjad Enhanced Model integrated"
          echo "✅ Multimodal Islamic AI deployed"
          echo "✅ All platforms synchronized"
