name: ADANiD Ecosystem Auto-Deploy

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0' # Weekly updates

env:
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
  KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install huggingface-hub kaggle supabase

      - name: Run tests
        run: |
          python -m pytest tests/ --verbose

  update-hf-dataset:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Hugging Face CLI and upload dataset
        run: |
          pip install huggingface-hub
          huggingface-cli login --token ${{ secrets.HF_TOKEN }}
          huggingface-cli upload ADANiD/Quranlab-islamic-dataset \
            datasets/quranlab-islamic-dataset \
            ./ \            --repo-type dataset

  update-hf-models:
    needs: update-hf-dataset
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Hugging Face CLI and upload models
        run: |
          pip install huggingface-hub
          huggingface-cli login --token ${{ secrets.HF_TOKEN }}
          huggingface-cli upload ADANiD/Quranlab \
            models/quranlab/README.md \
            ./ \
            --repo-type model
          huggingface-cli upload ADANiD/Quranlab-AI \
            models/quranlab-ai/README.md \
            ./ \
            --repo-type model

  update-kaggle:
    needs: update-hf-models
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Kaggle CLI and update dataset
        run: |
          pip install kaggle
          mkdir -p ~/.kaggle
          echo '{"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_KEY }}"}' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json
          kaggle datasets version \
            -p nooreabjad-dataset \
            -m "Auto-update: $(date)"

  update-supabase:
    needs: update-kaggle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Supabase CLI and deploy schema
        run: |
          npm install -g supabase
          supabase db push \            --project-ref wcrchcdqaikhrhqzxfcy \
            --api-key ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

  deploy-hf-space:
    needs: update-supabase
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Hugging Face Space
        run: |
          pip install huggingface-hub
          huggingface-cli login --token ${{ secrets.HF_TOKEN }}
          huggingface-cli upload ADANiD/quranlab-demo \
            spaces/quranlab-demo \
            ./ \
            --repo-type space

  notify:
    needs: deploy-hf-space
    runs-on: ubuntu-latest
    steps:
      - name: Send success notification
        run: |
          echo "âœ… ADANiD Ecosystem auto-deployed successfully!"
